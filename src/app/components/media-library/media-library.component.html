<div class="selected-moments-container">
  <app-header></app-header>

  <main class="main-content">
    <div class="moments-card">
      <div class="content-section">
        <div class="loading-section" *ngIf="isLoadingEvents">
          <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
          </div>
          <h2>Loading Media</h2>
          <p>Please wait while we fetch photos and videos...</p>
        </div>

        <div class="error-section" *ngIf="errorMessage">
          <div class="error-icon">丘멆잺</div>
          <h2>Error Loading Media</h2>
          <p>{{ errorMessage }}</p>
          <button class="retry-button" (click)="loadAllVideos()">
            <i class="fas fa-redo"></i>
            Try Again
          </button>
        </div>

        <div class="library-section" *ngIf="!isLoadingEvents && !errorMessage && allItems.length > 0">
          <div class="library-header">
            <h2 class="library-title">{{ getMatchHeaderLine() }}</h2>
            <p class="">{{ getMatchDate() }}</p>
            <div class="mb-3 library-header-buttons">
              <button class="button-green" (click)="onShareLibrary()" title="Partilhar biblioteca">
                <i class="fas fa-share"></i>
                <span>Partilhar</span>
              </button>
              <button 
                class="add-to-games-button" 
                [class.added]="isMatchAddedToFavorites"
                (click)="onAddToMyGames()" 
                [title]="isMatchAddedToFavorites ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                <i [class.fas]="true" [class.fa-star]="true"></i>
                <span>{{ isMatchAddedToFavorites ? 'Remover dos favoritos' : 'Adicionar aos favoritos' }}</span>
              </button>
            </div>
            <!--div class="library-counter">{{ allItems.length }} item{{ allItems.length !== 1 ? 's' : '' }}</div-->
          </div>

          <!-- Registration message for non-authenticated users -->
          <div class="registration-message" *ngIf="!isAuthenticated()">
            <p>
              <i class="fas fa-exclamation-circle registration-icon"></i>
              <span>
                Cria o teu hist칩rico adicionando os teus jogos e melhores momentos aos favoritos. 
                <a (click)="navigateToRegistration(); $event.preventDefault()" class="registration-link">Regista-te</a> para usufruir desta funcionalidade.
              </span>
            </p>
          </div>

          <div class="library-content">
            <!-- Resumo -->
            <div *ngIf="resumoItems.length > 0">
              <!-- Small processing message at top if any items are null -->
              <div *ngIf="hasNullPresignedUrlInSection('resumo')" class="processing-notice">
                <p class="processing-text">O resumo ainda est치 a ser processado, aguarda um momento</p>
              </div>
              
              <div class="row g-3">
                <!-- Show all items -->
                <div class="col-12" *ngFor="let item of resumoItems" [ngClass]="{ 'expanded-col': currentPreviewItem?.id === getItemId(item) }">
                  <div class="event-card resumo-card" [class.selected]="isItemSelected(item)" [class.expanded]="currentPreviewItem?.id === getItemId(item)" [class.disabled]="isItemDisabled(item)" (click)="!isItemDisabled(item) ? onSelectItem(item) : null">
                    <div class="event-header">
                      <div class="event-icon"><span [innerHTML]="getItemIcon(item)"></span></div>
                      <div class="event-time">
                        <p class="time-text">{{ getItemDescription(item) }}</p>
                        <p class="team-name-text" *ngIf="isItemGoal(item)">{{ getItemTeamName(item) }}</p>
                      </div>
                    </div>
                    <div class="event-thumbnail" (click)="!isItemDisabled(item) ? onItemClick(item, $event) : $event.stopPropagation()">
                      <!-- Show processing message for PROCESSING or RETRYING status -->
                      <div *ngIf="isItemProcessing(item)" class="processing-placeholder">
                        <i class="fas fa-spinner fa-pulse"></i>
                        <p>A processar...</p>
                      </div>

                      <!-- Show error message for PROCESSING_FAILED status -->
                      <div *ngIf="isItemProcessingFailed(item)" class="processing-placeholder failed">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Lamentamos, mas n칚o foi poss칤vel extrair o v칤deo deste momento</p>
                      </div>
                      
                      <!-- Show normal content for RETRIEVED status -->
                      <ng-container *ngIf="!isItemProcessing(item) && !isItemProcessingFailed(item)">
                        <ng-container *ngIf="isItemPhoto(item); else videoTplResumo">
                          <img class="thumb-photo" [class.expanded-photo]="currentPreviewItem?.id === getItemId(item)" [src]="getItemUrl(item)" alt="photo" />
                          <button class="close-photo-button" *ngIf="currentPreviewItem?.id === getItemId(item)" (click)="currentPreviewItem = null; $event.stopPropagation()"><i class="fas fa-times"></i></button>
                        </ng-container>
                        <ng-template #videoTplResumo>
                          <div class="video-thumbnail-container">
                            <img class="thumb-photo" [src]="getResumoThumbnailUrl(item)" alt="video thumbnail" />
                            <video 
                              #itemVideo
                              [src]="getItemUrl(item)"
                              [muted]="false"
                              [loop]="false"
                              controls
                              class="thumb-video"
                              [class.hidden]="currentPreviewItem?.id !== getItemId(item)"
                              [attr.data-item-id]="getItemId(item)"
                              (ended)="onVideoEnded($event)"
                              (error)="onVideoError($event)"
                              (loadeddata)="onVideoLoaded()"
                              (canplay)="onVideoLoaded()"
                              (play)="onVideoPlay($event)">
                            </video>
                            <button class="thumb-play-button" *ngIf="currentPreviewItem?.id !== getItemId(item)" (click)="onPreviewItem(item); $event.stopPropagation()"><i class="fas fa-play"></i></button>
                            <button class="close-video-button" *ngIf="currentPreviewItem?.id === getItemId(item)" (click)="currentPreviewItem = null; $event.stopPropagation()"><i class="fas fa-times"></i></button>
                          </div>
                        </ng-template>
                      </ng-container>
                    </div>
                    <div class="event-actions">
                      <button class="action-button share" [disabled]="isItemDisabled(item)" title="Partilhar" (click)="openShareModal(item); $event.stopPropagation()"><i class="fas fa-share"></i></button>
                      <button class="action-button download" [disabled]="isItemDisabled(item)" title="Transferir" (click)="onDownloadItem(item); $event.stopPropagation()"><i class="fas fa-download"></i></button>
                      <button 
                        *ngIf="item.type === 'goal-event' || item.type === 'highlight-event'" 
                        class="action-button goals" 
                        [class.added]="isVideoSegmentAdded(item)"
                        [disabled]="isItemDisabled(item)" 
                        [title]="isVideoSegmentAdded(item) ? 'Remover dos meus golos' : 'Adicionar aos meus golos'" 
                        (click)="onAddToMyGoals(item); $event.stopPropagation()">
                        <i [class.fas]="isVideoSegmentAdded(item)" [class.far]="!isVideoSegmentAdded(item)" [class.fa-star]="true"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Todos os Momentos -->
            <div class="section" *ngIf="momentItems.length > 0">
              <div class="section-header mb-4 mt-4">
                <h3>Golos e melhores momentos</h3>
              </div>
              
              <!-- Small processing message at top if any items are null -->
              <div *ngIf="hasNullPresignedUrlInSection('momentos')" class="processing-notice">
                <p class="processing-text">Alguns dos v칤deos ainda est칚o a ser processados, aguarda um momento</p>
              </div>
              
              <div class="row g-3">
                <!-- Show all items -->
                <div class="col-12 col-sm-6 col-md-4 col-lg-4" *ngFor="let item of momentItems" [ngClass]="{ 'expanded-col': currentPreviewItem?.id === getItemId(item) }">
                  <div class="event-card moment-card" [class.selected]="isItemSelected(item)" [class.expanded]="currentPreviewItem?.id === getItemId(item)" [class.disabled]="isItemDisabled(item)" (click)="!isItemDisabled(item) ? onSelectItem(item) : null">
                    <div class="event-header">
                      <div class="event-icon"><span [innerHTML]="getItemIcon(item)"></span></div>
                      <div class="event-time">
                        <p class="time-text">{{ getItemDescription(item) }}</p>
                        <p class="team-name-text" *ngIf="isItemGoal(item)">{{ getItemTeamName(item) }}</p>
                      </div>
                      <div class="team-name"><span class="team-score" *ngIf="isItemGoal(item)">({{ getItemResult(item) }})</span></div>
                    </div>
                    <div class="event-thumbnail" (click)="!isItemDisabled(item) ? onItemClick(item, $event) : $event.stopPropagation()">
                      <!-- Show processing message for PROCESSING or RETRYING status -->
                      <div *ngIf="isItemProcessing(item)" class="processing-placeholder">
                        <i class="fas fa-spinner fa-pulse"></i>
                        <p>A processar...</p>
                      </div>

                      <!-- Show error message for PROCESSING_FAILED status -->
                      <div *ngIf="isItemProcessingFailed(item)" class="processing-placeholder failed">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Lamentamos, mas n칚o foi poss칤vel extrair o v칤deo deste momento</p>
                      </div>
                      
                      <!-- Show normal content for RETRIEVED status -->
                      <ng-container *ngIf="!isItemProcessing(item) && !isItemProcessingFailed(item)">
                        <ng-container *ngIf="isItemPhoto(item); else videoTplMomentos">
                          <img class="thumb-photo" [class.expanded-photo]="currentPreviewItem?.id === getItemId(item)" [src]="getItemUrl(item)" alt="photo" />
                          <button class="close-photo-button" *ngIf="currentPreviewItem?.id === getItemId(item)" (click)="currentPreviewItem = null; $event.stopPropagation()"><i class="fas fa-times"></i></button>
                        </ng-container>
                        <ng-template #videoTplMomentos>
                          <div class="video-thumbnail-container">
                            <img class="thumb-photo" [src]="getMomentoThumbnailUrl(item)" alt="video thumbnail" />
                            <video 
                              #itemVideo 
                              [src]="getItemUrl(item)" 
                              [muted]="false" 
                              [loop]="false" 
                              controls 
                              class="thumb-video" 
                              [class.hidden]="currentPreviewItem?.id !== getItemId(item)"
                              [attr.data-item-id]="getItemId(item)"
                              (ended)="onVideoEnded($event)" 
                              (error)="onVideoError($event)" 
                              (loadeddata)="onVideoLoaded($event)" 
                              (canplay)="onVideoLoaded($event)"
                              (play)="onVideoPlay($event)">
                            </video>
                            <button class="thumb-play-button" *ngIf="currentPreviewItem?.id !== getItemId(item)" (click)="onPreviewItem(item); $event.stopPropagation()"><i class="fas fa-play"></i></button>
                            <button class="close-video-button" *ngIf="currentPreviewItem?.id === getItemId(item)" (click)="currentPreviewItem = null; $event.stopPropagation()"><i class="fas fa-times"></i></button>
                          </div>
                        </ng-template>
                      </ng-container>
                    </div>
                    <div class="event-actions">
                      <button class="action-button share" [disabled]="isItemDisabled(item)" title="Partilhar" (click)="openShareModal(item); $event.stopPropagation()"><i class="fas fa-share"></i></button>
                      <button class="action-button download" [disabled]="isItemDisabled(item)" title="Transferir" (click)="onDownloadItem(item); $event.stopPropagation()"><i class="fas fa-download"></i></button>
                      <button 
                        *ngIf="item.type === 'goal-event' || item.type === 'highlight-event'" 
                        class="action-button goals" 
                        [class.added]="isVideoSegmentAdded(item)"
                        [disabled]="isItemDisabled(item)" 
                        [title]="isVideoSegmentAdded(item) ? 'Remover dos meus golos' : 'Adicionar aos meus golos'" 
                        (click)="onAddToMyGoals(item); $event.stopPropagation()">
                        <i [class.fas]="isVideoSegmentAdded(item)" [class.far]="!isVideoSegmentAdded(item)" [class.fa-star]="true"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Fotos -->
            <div class="section" *ngIf="photoItems.length > 0">
              <div class="section-header mb-4 mt-4">
                <h3>Fotos</h3>
              </div>
              
              <!-- Small processing message at top if any items are null -->
              <div *ngIf="hasNullPresignedUrlInSection('fotos')" class="processing-notice">
                <p class="processing-text">Algumas das fotos ainda est칚o a ser processadas</p>
              </div>
              
              <div class="row g-3">
                <!-- Show all items -->
                <div class="col-12 col-sm-6 col-md-4 col-lg-4" *ngFor="let item of photoItems" [ngClass]="{ 'expanded-col': currentPreviewItem?.id === getItemId(item) }">
                  <div class="event-card photo-card" [class.selected]="isItemSelected(item)" [class.expanded]="currentPreviewItem?.id === getItemId(item)" [class.disabled]="isItemDisabled(item)" (click)="!isItemDisabled(item) ? onSelectItem(item) : null">
                    <div class="event-header">
                      <div class="event-icon"><span [innerHTML]="getItemIcon(item)"></span></div>
                      <div class="event-time">
                        <p class="time-text">{{ getItemDescription(item) }}</p>
                        <p class="team-name-text" *ngIf="isItemGoal(item)">{{ getItemTeamName(item) }}</p>
                      </div>
                    </div>
                    <div class="event-thumbnail" (click)="!isItemDisabled(item) ? onItemClick(item, $event) : $event.stopPropagation()">
                      <!-- Show processing message for PROCESSING or RETRYING status -->
                      <div *ngIf="isItemProcessing(item)" class="processing-placeholder">
                        <i class="fas fa-spinner fa-pulse"></i>
                        <p>A processar...</p>
                      </div>

                      <!-- Show error message for PROCESSING_FAILED status -->
                      <div *ngIf="isItemProcessingFailed(item)" class="processing-placeholder failed">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Lamentamos, mas n칚o foi poss칤vel extrair o v칤deo deste momento</p>
                      </div>
                      
                      <!-- Show normal content for RETRIEVED status -->
                      <ng-container *ngIf="!isItemProcessing(item) && !isItemProcessingFailed(item)">
                        <img class="thumb-photo" [class.expanded-photo]="currentPreviewItem?.id === getItemId(item)" [src]="getItemUrl(item)" alt="photo" />
                        <button class="close-photo-button" *ngIf="currentPreviewItem?.id === getItemId(item)" (click)="currentPreviewItem = null; $event.stopPropagation()"><i class="fas fa-times"></i></button>
                      </ng-container>
                    </div>
                    <div class="event-actions">
                      <button class="action-button share" [disabled]="isItemDisabled(item)" title="Partilhar" (click)="openShareModal(item); $event.stopPropagation()"><i class="fas fa-share"></i></button>
                      <button class="action-button download" [disabled]="isItemDisabled(item)" title="Transferir" (click)="onDownloadItem(item); $event.stopPropagation()"><i class="fas fa-download"></i></button>
                      <button 
                        *ngIf="item.type === 'goal-event' || item.type === 'highlight-event'" 
                        class="action-button goals" 
                        [class.added]="isVideoSegmentAdded(item)"
                        [disabled]="isItemDisabled(item)" 
                        [title]="isVideoSegmentAdded(item) ? 'Remover dos meus golos' : 'Adicionar aos meus golos'" 
                        (click)="onAddToMyGoals(item); $event.stopPropagation()">
                        <i [class.fas]="isVideoSegmentAdded(item)" [class.far]="!isVideoSegmentAdded(item)" [class.fa-star]="true"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="selected-events-section" *ngIf="getSelectedCount() > 0">
          <div class="selected-events-header">
            <h3 class="selected-title">Selecionados: ({{ getSelectedCount() }})</h3>
          </div>
          <div class="selected-events-list">
            <div class="selected-event-item" *ngFor="let item of selectedItems">
              <div class="selected-event-icon">
                <span [innerHTML]="getItemIcon(item)"></span>
              </div>
              <div class="selected-event-info">
                <span class="selected-event-time">{{ getItemDescription(item) }}</span>
                <span class="selected-event-team">
                  <span class="team-score" *ngIf="isItemGoal(item)">({{ getItemResult(item) }})</span>
                  {{ getItemName(item) }}
                </span>
              </div>
              <button class="remove-button" (click)="removeSelectedItem(item)" title="Remove from selection">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="empty-section" *ngIf="!isLoadingEvents && !errorMessage && allItems.length === 0">
          <div class="empty-icon">游닟</div>
          <h2>N칚o foram encontrados conte칰dos para este jogo.</h2>
          <button class="back-to-download-button" (click)="onBackClick()">
            <i class="fas fa-arrow-left"></i>
            Procurar outro jogo
          </button>
        </div>
      </div>
      <!-- Share Modal -->
      <div class="share-modal-backdrop" *ngIf="isShareModalOpen" (click)="closeShareModal()"></div>
      <div class="share-modal" *ngIf="isShareModalOpen" (click)="$event.stopPropagation()">
        <div class="share-modal-header">
          <h4>Partilhar</h4>
          <button class="close-modal" (click)="closeShareModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="share-modal-body">
          <button class="share-option whatsapp" (click)="shareToWhatsApp(); closeShareModal()">
            <i class="fab fa-whatsapp"></i>
            <span>Partilhar no WhatsApp</span>
          </button>
          <button class="share-option copy" (click)="copyLink(); closeShareModal()">
            <i class="fas fa-link"></i>
            <span>Copiar liga칞칚o</span>
          </button>
        </div>
      </div>

      <!-- Registration Modal -->
      <div class="share-modal-backdrop" *ngIf="isRegistrationModalOpen" (click)="closeRegistrationModal()"></div>
      <div class="share-modal registration-modal" *ngIf="isRegistrationModalOpen" (click)="$event.stopPropagation()">
        <div class="share-modal-header">
          <h4>Registo necess치rio</h4>
          <button class="close-modal" (click)="closeRegistrationModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="share-modal-body">
          <p class="registration-modal-message">
            <i class="fas fa-exclamation-circle registration-icon"></i>
            <span>
              <a (click)="navigateToRegistration(); $event.preventDefault()" class="registration-link">
                Regista-te</a> para adicionar aos favoritos.
            </span>
          </p>
        </div>
      </div>

      <!-- Information Modal for First-Time Logged-In Users -->
      <div class="share-modal-backdrop" *ngIf="isInfoModalOpen" (click)="closeInfoModal()"></div>
      <div class="share-modal info-modal" *ngIf="isInfoModalOpen" (click)="$event.stopPropagation()">
        <div class="share-modal-header">
          <h4>Bem-vindo!</h4>
          <button class="close-modal" (click)="closeInfoModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="share-modal-body">
          <p class="info-modal-message">
            <i class="fas fa-info-circle info-icon"></i>
            <span>
              Como utilizador registado, constroi o teu hist칩rico de jogos, golos e melhores momentos, adicionando-os aos favoritos.
            </span>
          </p>
          <img src="assets/favorite-instructions.jpeg" alt="Favorite instructions" class="info-modal-image" />
        </div>
      </div>

      <div class="card-footer" *ngIf="!isLoadingEvents && !errorMessage && allItems.length > 0">
        <button class="button-green" [disabled]="getSelectedCount() === 0" (click)="onDownloadSelected()">
          <i class="fas fa-download"></i>
          Download {{ getSelectedCount() }} v칤deo{{ getSelectedCount() !== 1 ? 's' : '' }}
        </button>
      </div>
    </div>
  </main>
</div>



