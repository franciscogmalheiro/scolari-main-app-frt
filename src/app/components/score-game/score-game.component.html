<div class="score-game-container" [class.has-edit-mode-bar]="isEditMode">
  <!-- Edit Mode Top Bar -->
  <div class="edit-mode-bar" *ngIf="isEditMode">
    <button class="edit-mode-close-btn" (click)="saveEditMode()" title="Sair do modo de correção">
      <i class="fas fa-chevron-left"></i>
    </button>
    <span class="edit-mode-text">MODO DE CORREÇÃO</span>
  </div>

  <!-- Main Game Section -->
  <div class="main-game-section" [class.has-edit-mode-bar]="isEditMode">
    <!-- Timer Display with Live Indicator or Start Button -->
    <div class="timer-section" *ngIf="!isEditMode">
      <!-- When match is started: show buttons and timer -->
      <div *ngIf="isMatchStarted" class="timer-with-buttons">
        <!-- Terminar button (left side) -->
        <button 
          *ngIf="!isMatchFinished" 
          class="btn btn-terminar-small" 
          (click)="finishMatch()">
          <i class="fas fa-stop"></i> TERMINAR
        </button>
        
        <!-- Timer display -->
        <div class="timer-display">
          {{ formatTime(secondsElapsed) }}
        </div>
        
        <!-- Corrigir button (right side) -->
        <button 
          *ngIf="!isMatchFinished" 
          class="btn btn-corrigir-small" 
          [class.btn-save-edit-small]="isEditMode"
          (click)="isEditMode ? saveEditMode() : toggleEditMode()">
          <i class="fas" [class.fa-edit]="!isEditMode" [class.fa-save]="isEditMode"></i> 
          {{ isEditMode ? 'GUARDAR' : 'CORRIGIR' }}
        </button>
      </div>
      
      <!-- When match hasn't started: show centered start button -->
      <div *ngIf="!isMatchStarted && !isMatchFinished" class="timer-start-section">
        <div class="start-buttons-container">
          <button 
            class="btn btn-start" 
            (click)="startMatch()">
            <i class="fas fa-play"></i> COMEÇAR JOGO
          </button>
          <button 
            class="btn btn-edit-teams" 
            (click)="openEditTeamsModal()">
            <i class="fas fa-edit"></i> EDITAR EQUIPAS
          </button>
        </div>
      </div>
    </div>

    <!-- Final Result Display (under timer) -->
    <div *ngIf="showFinalResult" class="final-result">
      <div class="ft-text">FINAL DO JOGO</div>
    </div>

    <!-- Teams and Score Row -->
    <div class="row align-items-center justify-content-center">
      <!-- Team A -->
      <div class="col-3 text-center">
        <div class="team-content" 
             *ngIf="!showControls" 
             (click)="editTeam('A')" 
             title="Click to edit team">
          <div class="team-icon" [style.color]="teamAColor">
            <i class="fas fa-tshirt"></i>
          </div>
          <div class="team-name">
            {{ teamAName }}
          </div>
        </div>
        <div class="team-content" *ngIf="showControls">
          <div class="team-icon" [style.color]="teamAColor">
            <i class="fas fa-tshirt"></i>
          </div>
          <div class="team-name">
            {{ teamAName }}
          </div>
        </div>
      </div>

      <!-- Score Display -->
      <div class="col-5 text-center px-0">
        <div class="score">
          {{ teamAScore }} - {{ teamBScore }}
        </div>
      </div>

      <!-- Team B -->
      <div class="col-3 text-center">
        <div class="team-content" 
             *ngIf="!showControls" 
             (click)="editTeam('B')" 
             title="Click to edit team">
          <div class="team-icon" [style.color]="teamBColor">
            <i class="fas fa-tshirt"></i>
          </div>
          <div class="team-name">
            {{ teamBName }}
          </div>
        </div>
        <div class="team-content" *ngIf="showControls">
          <div class="team-icon" [style.color]="teamBColor">
            <i class="fas fa-tshirt"></i>
          </div>
          <div class="team-name">
            {{ teamBName }}
          </div>
        </div>
      </div>
    </div>

     <!-- Access Video Button (only shown when match is finished) -->
    <div class="row align-items-center justify-content-center mb-4">
      <div class="col-12 text-center">
        <div *ngIf="isMatchFinished && isRecordingMode" class="access-video-section">
          <button class="btn btn-start" (click)="onAccessVideo()">
            <i class="fas fa-video"></i> Aceder aos vídeos
          </button>
        </div>
      </div>
   </div>

    <!-- Action Buttons Row -->
    <div class="row align-items-center justify-content-center mb" *ngIf="showControls">
      <!-- Team A Goal Button -->
      <div class="col-3 text-center px-0">
        <button class="btn btn-goal team-a-goal" (click)="addTeamGoal('A')" [disabled]="isEditMode">
          <i class="fas fa-futbol"></i>
          <span class="goal-text">GOLO</span>
        </button>
      </div>

      <!-- Highlight Button -->
      <div class="col-5 text-center px-0">
        <button class="btn btn-highlight" (click)="addHighlight()" [disabled]="isEditMode">
          <i class="fas fa-hands-clapping"></i>
          <span class="highlight-text">DESTAQUE</span>
        </button>
      </div>

      <!-- Team B Goal Button -->
      <div class="col-3 text-center px-0">
        <button class="btn btn-goal team-b-goal" (click)="addTeamGoal('B')" [disabled]="isEditMode">
          <i class="fas fa-futbol"></i>
          <span class="goal-text">GOLO</span>
        </button>
      </div>
    </div>

    <!-- Event Logs -->
    <app-event-log class="mt-3"
      [teamAEvents]="teamAEvents"
      [teamBEvents]="teamBEvents"
      [highlightEvents]="highlightEvents"
      [showControls]="showControls"
      [teamAScore]="teamAScore"
      [teamBScore]="teamBScore"
      [teamAColor]="teamAColor"
      [teamBColor]="teamBColor"
      [isEditMode]="isEditMode"
      [isMatchFinished]="isMatchFinished"
      (editEvent)="openEventEditModal($event)"
    ></app-event-log>

  </div>

  <!-- Edit Both Teams Modal -->
  <div class="teams-edit-modal-backdrop" *ngIf="showEditTeamsModal" (click)="closeEditTeamsModal()"></div>
  <div class="teams-edit-modal" *ngIf="showEditTeamsModal" (click)="$event.stopPropagation()">
    <div class="teams-edit-content">
      <div class="teams-edit-header">
        <h4>Editar Equipas</h4>
        <button class="close-modal" (click)="closeEditTeamsModal()"><i class="fas fa-times"></i></button>
      </div>
      
      <div class="teams-edit-body">
        <!-- Team A Section -->
        <div class="team-section">
          <h5>Equipa da casa</h5>
          <div class="input-group">
            <input 
              type="text" 
              #teamANameInput
              [value]="teamAName"
              (input)="teamAName = teamANameInput.value"
              placeholder="Nome da equipa A"
              class="name-input"
              maxlength="20"
            >
          </div>
          <div class="input-group">
            <div class="color-picker">
              <button 
                *ngFor="let color of teamColorOptions" 
                type="button"
                class="color-option"
                [ngStyle]="{'background-color': color}"
                [class.selected]="teamAColor === color"
                (click)="teamAColor = color"
                [attr.aria-label]="color"
              >
                <i class="fas fa-check" *ngIf="teamAColor === color"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Team B Section -->
        <div class="team-section">
          <h5>Equipa visitante</h5>
          <div class="input-group">
            <input 
              type="text" 
              #teamBNameInput
              [value]="teamBName"
              (input)="teamBName = teamBNameInput.value"
              placeholder="Nome da equipa B"
              class="name-input"
              maxlength="20"
            >
          </div>
          <div class="input-group">
            <div class="color-picker">
              <button 
                *ngFor="let color of teamColorOptions" 
                type="button"
                class="color-option"
                [ngStyle]="{'background-color': color}"
                [class.selected]="teamBColor === color"
                (click)="teamBColor = color"
                [attr.aria-label]="color"
              >
                <i class="fas fa-check" *ngIf="teamBColor === color"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="teams-edit-footer">
        <button class="btn btn-cancel" (click)="closeEditTeamsModal()">
          Cancelar
        </button>
        <button class="btn btn-save" (click)="onSaveBothTeams({ name: teamAName, color: teamAColor }, { name: teamBName, color: teamBColor })" [disabled]="!teamAName.trim() || !teamBName.trim()">
          Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- Start Match Confirmation Modal -->
  <app-confirmation-modal
    [isVisible]="showStartConfirmModal"
    title="Start New Match"
    message="Starting a new match will clear the current events. Proceed?"
    confirmText="Start Match"
    cancelText="Cancel"
    (confirm)="onConfirmStartMatch()"
    (cancel)="onCancelStartMatch()"
  ></app-confirmation-modal>

  <!-- Attacking Team Selection Modal (recording mode) -->
  <app-confirmation-modal
    [isVisible]="showAttackingTeamModal"
    title="Por trás de uma das balizas, há um logotipo Scolari. Que equipa vai estar a atacar para essa baliza?"
    message=""
    [confirmText]="teamBName"
    [cancelText]="teamAName"
    [confirmButtonColor]="teamBColor"
    [cancelButtonColor]="teamAColor"
    [disableOverlayClose]="true"
    imageUrl="assets/court-map-2.png"
    (confirm)="chooseAttackingTeam('A')"
    (cancel)="chooseAttackingTeam('B')"
  ></app-confirmation-modal>

  <!-- Start Match Error Modal -->
  <app-confirmation-modal
    [isVisible]="showStartMatchErrorModal"
    title="Erro ao iniciar jogo"
    message="Não foi possível iniciar o jogo. Por favor insere novamente o código de gravação"
    confirmText="OK"
    cancelText=""
    (confirm)="onCloseStartMatchErrorModal()"
    (cancel)="onCloseStartMatchErrorModal()"
  ></app-confirmation-modal>

  <!-- Finish Match Confirmation Modal -->
  <div class="teams-edit-modal-backdrop" *ngIf="showConfirmModal" (click)="onCancelFinishMatch()"></div>
  <div class="teams-edit-modal" *ngIf="showConfirmModal" (click)="$event.stopPropagation()">
    <div class="teams-edit-content">
      <div class="teams-edit-header">
        <h4>{{ isRecordingMode ? 'Terminar o jogo e gravação' : 'Terminar o Jogo' }}</h4>
        <button class="close-modal" (click)="onCancelFinishMatch()"><i class="fas fa-times"></i></button>
      </div>
      
      <div class="teams-edit-body">
        <p style="color: white; margin: 0; font-size: 1rem; line-height: 1.5;">
          {{ isRecordingMode ? 'Tens a certeza que queres terminar o jogo e parar a gravação?' : 'Tens a certeza que queres terminar o jogo?' }}
        </p>
      </div>
      
      <div class="teams-edit-footer">
        <button class="btn btn-cancel" (click)="onCancelFinishMatch()">
          Cancelar
        </button>
        <button class="btn btn-save" (click)="onConfirmFinishMatch()">
          Terminar o Jogo
        </button>
      </div>
    </div>
  </div>

  <!-- QR Code Modal (only shown when NOT in recording mode) -->
  <app-qr-modal
    *ngIf="!isRecordingMode"
    [isVisible]="showQrModal"
    [gameId]="gameId"
    [qrCodeData]="qrCodeData"
    (closeModal)="onCloseQrModal()"
  ></app-qr-modal>

  <!-- Photo Capture Modal -->
  <div class="photo-capture-modal" *ngIf="isCapturingPhoto">
    <div class="photo-capture-content">
      <div class="photo-capture-header">
        <h3>Querem tirar a foto de final de Jogo?</h3>
      </div>
      
      <div class="photo-capture-body">
        <div class="photo-preview" *ngIf="photoUploadProgress === 0">
          <div class="camera-icon">
            <i class="fas fa-camera"></i>
          </div>
          <p>A Camera irá abrir assim que clicarem no botão de "Tirar Foto"</p>
        </div>
        
        <div class="upload-progress" *ngIf="photoUploadProgress > 0">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="photoUploadProgress"></div>
          </div>
          <p *ngIf="photoUploadProgress < 100">Uploading photo...</p>
          <p *ngIf="photoUploadProgress === 100">Photo uploaded successfully!</p>
        </div>
      </div>
      
      <div class="photo-capture-controls">
        <button 
          class="btn btn-secondary" 
          (click)="skipPhotoCapture()"
          [disabled]="photoUploadProgress > 0">
          Não tirar
        </button>
        <button 
          class="btn btn-primary" 
          (click)="retryPhotoCapture()"
          [disabled]="photoUploadProgress > 0">
          <i class="fas fa-camera"></i> Tirar Foto
        </button>
      </div>
    </div>
  </div>

  <!-- Large Photo Preview Modal -->
  <div class="photo-preview-modal" *ngIf="showPhotoPreviewModal">
    <div class="photo-preview-content">
      <button class="close-preview-btn" (click)="closePhotoPreview()">&times;</button>
      <h3>Match Photo</h3>
      <img *ngIf="lastCapturedPhotoUrl" [src]="lastCapturedPhotoUrl" alt="Match photo" class="photo-preview-image" />
    </div>
  </div>

  <!-- Event Edit Modal -->
  <div class="event-edit-modal" *ngIf="showEventEditModal">
    <div class="event-edit-content">
      <div class="event-edit-header">
        <h3>Editar: {{ getCurrentEventType() | titlecase }}</h3>
        <button class="close-edit-btn" (click)="closeEventEditModal()">&times;</button>
      </div>
      
      <div class="event-edit-body">
        <!-- Result Preview -->
        <div class="result-preview">
          <div class="preview-label">Resultado</div>
          <div class="preview-score-display">
            <!-- Team A -->
            <div class="preview-team">
              <div class="preview-team-icon" [style.color]="teamAColor">
                <i class="fas fa-tshirt"></i>
              </div>
              <div class="preview-team-name">{{ teamAName }}</div>
              <div class="preview-score-value" 
                   [class.blinking]="isTeamAScoreBeingEdited()">
                {{ getNewTeamAScore() }}
              </div>
            </div>
            
            <!-- Score Separator -->
            <div class="preview-score-separator">-</div>
            
            <!-- Team B -->
            <div class="preview-team">
              <div class="preview-team-icon" [style.color]="teamBColor">
                <i class="fas fa-tshirt"></i>
              </div>
              <div class="preview-team-name">{{ teamBName }}</div>
              <div class="preview-score-value" 
                   [class.blinking]="isTeamBScoreBeingEdited()">
                {{ getNewTeamBScore() }}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Event Type Selection -->
        <div class="form-group">
          <label>Tipo de Evento:</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" 
                     name="eventType" 
                     value="goal" 
                     [(ngModel)]="editingEventType"
                     [checked]="editingEventType === 'goal'">
              <span class="radio-icon"><i class="fas fa-futbol"></i></span>
              <span class="radio-label">Golo</span>
            </label>
            <label class="radio-option">
              <input type="radio" 
                     name="eventType" 
                     value="highlight" 
                     [(ngModel)]="editingEventType"
                     [checked]="editingEventType === 'highlight'">
              <span class="radio-icon"><i class="fas fa-hands-clapping"></i></span>
              <span class="radio-label">Destaque</span>
            </label>
          </div>
        </div>

        <!-- Team Selection (only for goals) -->
        <div class="form-group" *ngIf="editingEventType === 'goal'">
          <label>Equipa:</label>
          <div class="radio-group">
            <label class="radio-option" 
                   data-team="A"
                   [ngStyle]="getTeamAStyle()"
                   [style.--team-color]="teamAColor">
              <input type="radio" 
                     name="eventTeam" 
                     value="A" 
                     [(ngModel)]="editingEventTeamSelection"
                     [checked]="editingEventTeamSelection === 'A'">
              <span class="radio-label" 
                    [ngStyle]="{'color': editingEventTeamSelection === 'A' ? teamAColor : '#495057'}">
                {{ teamAName }}
              </span>
            </label>
            <label class="radio-option" 
                   data-team="B"
                   [ngStyle]="getTeamBStyle()"
                   [style.--team-color]="teamBColor">
              <input type="radio" 
                     name="eventTeam" 
                     value="B" 
                     [(ngModel)]="editingEventTeamSelection"
                     [checked]="editingEventTeamSelection === 'B'">
              <span class="radio-label" 
                    [ngStyle]="{'color': editingEventTeamSelection === 'B' ? teamBColor : '#495057'}">
                {{ teamBName }}
              </span>
            </label>
          </div>
        </div>
      </div>
      
      <div class="event-edit-controls">
        <button class="btn btn-danger" (click)="deleteEvent()">
          <i class="fas fa-trash"></i> Eliminar
        </button>
        <button class="btn btn-primary" (click)="saveEventEdit()">
          <i class="fas fa-save"></i> Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- Live Indicator Dock Bar (bottom of page) -->
  <div class="live-indicator-dock" *ngIf="isRecordingMode && isMatchStarted">
    <app-live-indicator [isRecording]="isRecording"></app-live-indicator>
  </div>
</div>
