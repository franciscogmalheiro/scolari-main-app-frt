<app-header></app-header>

<div class="score-game-container">
  <!-- Main Game Section -->
  <div class="main-game-section">
    <!-- Timer Display with Live Indicator or Start Button -->
    <div class="timer-section">
      <!-- Show timer when match is started -->
      <div class="timer-display" *ngIf="isMatchStarted">
        {{ formatTime(secondsElapsed) }}
      </div>
      <!-- Finish Match Button (under timer) -->
    
      <!-- Show start button when match hasn't started -->
      <button 
        *ngIf="!isMatchStarted && !isMatchFinished" 
        class="btn btn-start" 
        (click)="startMatch()">
        <i class="fas fa-play"></i> COME√áAR JOGO
      </button>
      <!-- Live Indicator positioned on the right -->
      <div class="live-indicator-container" *ngIf="isRecordingMode && isMatchStarted">
        <app-live-indicator [isRecording]="isRecording"></app-live-indicator>
      </div>
    </div>

    

    <!-- Final Result Display (under timer) -->
    <div *ngIf="showFinalResult" class="final-result">
      <div class="ft-text">FINAL DO JOGO</div>
    </div>

    <!-- Teams and Score Row -->
    <div class="row align-items-center justify-content-center">
      <!-- Team A -->
      <div class="col-3 text-center">
        <div class="team-content" 
             *ngIf="!showControls" 
             (click)="editTeam('A')" 
             title="Click to edit team">
          <div class="team-icon" [style.color]="teamAColor">
            <i class="fas fa-tshirt"></i>
          </div>
          <div class="team-name">
            {{ teamAName }}
          </div>
        </div>
        <div class="team-content" *ngIf="showControls">
          <div class="team-icon" [style.color]="teamAColor">
            <i class="fas fa-tshirt"></i>
          </div>
          <div class="team-name">
            {{ teamAName }}
          </div>
        </div>
      </div>

      <!-- Score Display -->
      <div class="col-5 text-center">
        <div class="score">
          {{ teamAScore }} - {{ teamBScore }}
        </div>
        <!-- Access Video Button (only shown when match is finished and QR modal is closed) -->
        <div *ngIf="isMatchFinished && isRecordingMode && !showQrModal" class="access-video-section">
          <button class="btn btn-access-video" (click)="showQrModal = true">
            <i class="fas fa-video"></i> Aceder ao V√≠deo
          </button>
        </div>
      </div>

      <!-- Team B -->
      <div class="col-3 text-center">
        <div class="team-content" 
             *ngIf="!showControls" 
             (click)="editTeam('B')" 
             title="Click to edit team">
          <div class="team-icon" [style.color]="teamBColor">
            <i class="fas fa-tshirt"></i>
          </div>
          <div class="team-name">
            {{ teamBName }}
          </div>
        </div>
        <div class="team-content" *ngIf="showControls">
          <div class="team-icon" [style.color]="teamBColor">
            <i class="fas fa-tshirt"></i>
          </div>
          <div class="team-name">
            {{ teamBName }}
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons Row -->
    <div class="row align-items-center justify-content-center mb-4" *ngIf="showControls">
      <!-- Team A Goal Button -->
      <div class="col-3 text-center">
        <button class="btn btn-goal team-a-goal" (click)="addTeamGoal('A')">
          <i class="fas fa-futbol"></i>
        </button>
      </div>

      <!-- Highlight Button -->
      <div class="col-5 text-center">
        <button class="btn btn-highlight" (click)="addHighlight()">
          <i class="fas fa-star"></i>
        </button>
      </div>

      <!-- Team B Goal Button -->
      <div class="col-3 text-center">
        <button class="btn btn-goal team-b-goal" (click)="addTeamGoal('B')">
          <i class="fas fa-futbol"></i>
        </button>
      </div>
    </div>

    <!-- Event Logs -->
    <app-event-log
      [teamAEvents]="teamAEvents"
      [teamBEvents]="teamBEvents"
      [highlightEvents]="highlightEvents"
      [showControls]="showControls"
      [teamAScore]="teamAScore"
      [teamBScore]="teamBScore"
      [teamAColor]="teamAColor"
      [teamBColor]="teamBColor"
      [isEditMode]="isEditMode"
      (editEvent)="openEventEditModal($event)"
    ></app-event-log>

    <div class="finish-button-section" *ngIf="isMatchStarted && !isMatchFinished">
      <button class="btn btn-edit-score" (click)="toggleEditMode()" *ngIf="!isEditMode">
        <i class="fas fa-edit"></i> CORRIGIR
      </button>
      <button class="btn btn-save-edit" (click)="saveEditMode()" *ngIf="isEditMode">
        <i class="fas fa-save"></i> GUARDAR
      </button>
      <button class="btn btn-finish-small" (click)="finishMatch()">
        <i class="fas fa-stop"></i> TERMINAR
      </button>
    </div>
  </div>

  <!-- Team Edit Modal -->
  <app-team-edit-modal
    [isOpen]="showEditModal"
    [teamData]="teamEditData"
    (save)="onTeamEditSave($event)"
    (cancel)="onTeamEditCancel()"
  ></app-team-edit-modal>

  <!-- Start Match Confirmation Modal -->
  <app-confirmation-modal
    [isVisible]="showStartConfirmModal"
    title="Start New Match"
    message="Starting a new match will clear the current events. Proceed?"
    confirmText="Start Match"
    cancelText="Cancel"
    (confirm)="onConfirmStartMatch()"
    (cancel)="onCancelStartMatch()"
  ></app-confirmation-modal>

  <!-- Finish Match Confirmation Modal -->
  <app-confirmation-modal
    [isVisible]="showConfirmModal"
    [title]="isRecordingMode ? 'Terminar o jogo e grava√ß√£o' : 'Terminar o Jogo'"
    [message]="isRecordingMode ? 'Tens a certeza que queres terminar o jogo e parar a grava√ß√£o?' : 'Tens a certeza que queres terminar o jogo?'"
    confirmText="Terminar o Jogo"
    cancelText="Cancelar"
    (confirm)="onConfirmFinishMatch()"
    (cancel)="onCancelFinishMatch()"
  ></app-confirmation-modal>

  <!-- QR Code Modal (only shown in recording mode) -->
  <app-qr-modal
    *ngIf="isRecordingMode"
    [isVisible]="showQrModal"
    [gameId]="gameId"
    [qrCodeData]="qrCodeData"
    (closeModal)="onCloseQrModal()"
  ></app-qr-modal>

  <!-- Photo Capture Modal -->
  <div class="photo-capture-modal" *ngIf="isCapturingPhoto">
    <div class="photo-capture-content">
      <div class="photo-capture-header">
        <h3>üì∏ Querem tirar a foto de final de Jogo?</h3>
      </div>
      
      <div class="photo-capture-body">
        <div class="photo-preview" *ngIf="photoUploadProgress === 0">
          <div class="camera-icon">
            <i class="fas fa-camera"></i>
          </div>
          <p>A Camera ir√° abrir assim que clicarem no bot√£o de "Tirar Foto"</p>
        </div>
        
        <div class="upload-progress" *ngIf="photoUploadProgress > 0">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="photoUploadProgress"></div>
          </div>
          <p *ngIf="photoUploadProgress < 100">Uploading photo...</p>
          <p *ngIf="photoUploadProgress === 100">Photo uploaded successfully!</p>
        </div>
      </div>
      
      <div class="photo-capture-controls">
        <button 
          class="btn btn-secondary" 
          (click)="skipPhotoCapture()"
          [disabled]="photoUploadProgress > 0">
          N√£o tirar
        </button>
        <button 
          class="btn btn-primary" 
          (click)="retryPhotoCapture()"
          [disabled]="photoUploadProgress > 0">
          <i class="fas fa-camera"></i> Tirar Foto
        </button>
      </div>
    </div>
  </div>

  <!-- Large Photo Preview Modal -->
  <div class="photo-preview-modal" *ngIf="showPhotoPreviewModal">
    <div class="photo-preview-content">
      <button class="close-preview-btn" (click)="closePhotoPreview()">&times;</button>
      <h3>Match Photo</h3>
      <img *ngIf="lastCapturedPhotoUrl" [src]="lastCapturedPhotoUrl" alt="Match photo" class="photo-preview-image" />
    </div>
  </div>

  <!-- Event Edit Modal -->
  <div class="event-edit-modal" *ngIf="showEventEditModal">
    <div class="event-edit-content">
      <div class="event-edit-header">
        <h3>Editar: {{ getCurrentEventType() | titlecase }}</h3>
        <button class="close-edit-btn" (click)="closeEventEditModal()">&times;</button>
      </div>
      
      <div class="event-edit-body">
        <!-- Result Preview -->
        <div class="result-preview">
          <span class="current-result">Resultado atual: {{ teamAScore }}-{{ teamBScore }}</span>
          <span class="separator">|</span>
          <span class="new-result">Novo resultado: {{ getNewEventResult() }}</span>
        </div>
        
        <!-- Event Type Selection -->
        <div class="form-group">
          <label>Tipo de Evento:</label>
          <div class="radio-group">
            <label class="radio-option">
              <input type="radio" 
                     name="eventType" 
                     value="goal" 
                     [(ngModel)]="editingEventType"
                     [checked]="editingEventType === 'goal'">
              <span class="radio-icon">‚öΩ</span>
              <span class="radio-label">Golo</span>
            </label>
            <label class="radio-option">
              <input type="radio" 
                     name="eventType" 
                     value="highlight" 
                     [(ngModel)]="editingEventType"
                     [checked]="editingEventType === 'highlight'">
              <span class="radio-icon">‚≠ê</span>
              <span class="radio-label">Destaque</span>
            </label>
          </div>
        </div>

        <!-- Team Selection (only for goals) -->
        <div class="form-group" *ngIf="editingEventType === 'goal'">
          <label>Equipa:</label>
          <div class="radio-group">
            <label class="radio-option" data-team="A">
              <input type="radio" 
                     name="eventTeam" 
                     value="A" 
                     [(ngModel)]="editingEventTeamSelection"
                     [checked]="editingEventTeamSelection === 'A'">
              <span class="radio-label">{{ teamAName }}</span>
            </label>
            <label class="radio-option" data-team="B">
              <input type="radio" 
                     name="eventTeam" 
                     value="B" 
                     [(ngModel)]="editingEventTeamSelection"
                     [checked]="editingEventTeamSelection === 'B'">
              <span class="radio-label">{{ teamBName }}</span>
            </label>
          </div>
        </div>
      </div>
      
      <div class="event-edit-controls">
        <button class="btn btn-danger" (click)="deleteEvent()">
          <i class="fas fa-trash"></i> Eliminar
        </button>
        <button class="btn btn-primary" (click)="saveEventEdit()">
          <i class="fas fa-save"></i> Guardar
        </button>
      </div>
    </div>
  </div>
</div>
