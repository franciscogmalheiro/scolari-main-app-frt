<div class="record-instructions-container">
  <app-header></app-header>

  <main class="main-content">
    <div class="instructions-card">
      <div class="card-header">
        <h1 *ngIf="validatedRecordingCode" class="card-title">Importante!</h1>
      </div>

      <div class="instructions-content">
        <!-- Recording Code Section (only shown when no code is validated) -->
        <div class="recording-code-section" *ngIf="!validatedRecordingCode">
          <div class="section-header" *ngIf="!validatedRecordingCode">
            <div class="section-title-row">
              <h3>QUERES GRAVAR O TEU JOGO</h3>
              <button 
                type="button"
                class="info-button"
                (click)="openTutorial()"
                title="Informação sobre códigos de gravação">
                <i>?</i>
              </button>
            </div>
            <p class="description">
              Para prosseguir com a gravação de jogo, insere o teu <strong>código de gravação</strong> que pode ser adquirido no café da Sede.
            </p>
          </div>

          <!-- Free recording code button (shown only if backend returned a free code) -->
          <div class="free-code-wrapper mb-3" *ngIf="freeRecordingCode && !validatedRecordingCode">
            <button
              type="button"
              class="button-purple"
              [disabled]="hasClaimedFreeRecordingCode"
              (click)="applyFreeRecordingCode()">
              OBTÉM O TEU PRIMEIRO CÓDIGO GRÁTIS
            </button>
          </div>
          
          <!-- Code validation form (only shown when no code is validated yet) -->
          <form [formGroup]="recordingCodeForm" (ngSubmit)="validateRecordingCode()" *ngIf="!validatedRecordingCode">
            <div class="code-input-group">
              <input 
                type="text" 
                formControlName="code" 
                placeholder="Código de gravação"
                class="code-input"
                [class.error]="codeValidationFailed">
              <button 
                type="submit" 
                class="button-green"
                [disabled]="isValidatingCode">
                <span *ngIf="!isValidatingCode">VALIDAR</span>
                <span *ngIf="isValidatingCode" class="spinner"></span>
              </button>
            </div>
            
            <!-- Code validation error -->
            <div *ngIf="codeValidationFailed" class="validation-error">
              <span class="error-icon">❌</span>
              <span>{{ codeValidationError }}</span>
            </div>
          </form>          
        </div>
        <p *ngIf="!validatedRecordingCode" class="description">
          <br>Caso optes por não gravar, podes continuar apenas com o marcador de resultado.
        </p>


        <!-- Instructions (only shown when recording code is validated) -->
        <div class="instruction-items" *ngIf="validatedRecordingCode">
          <!--h3>O teu jogo vai ser filmado!</h3-->
          <div class="instruction-item">
            <div class="instruction-number"></div>
            <div class="instruction-text">
              Regista cada golo e highlight logo após ocorrerem (até 7 segundos), para garantir o registo do momento.
            </div>
          </div>


          <div class="instruction-item">
            <div class="instruction-number"></div>
            <div class="instruction-text">
              Usa o botão "highlight" para registar aqueles lances de levar as mãos à cabeça.
            </div>
          </div>

          <div class="instruction-item">
            <div class="instruction-number"></div>
            <div class="instruction-text">
              Se te enganares a registar, prime o botão "corrigir".
            </div>
          </div>

          <div class="instruction-item">
            <div class="instruction-number"></div>
            <div class="instruction-text">
              A gravação tem uma duração máxima de 90 minutos.
            </div>
          </div>
          
          <div class="instruction-item">
            <div class="instruction-number"></div>
            <div class="instruction-text">
              Diverte-te!
            </div>
          </div>
        </div>

        <!-- Camera Health Check Section (only for recording mode) -->
        <div class="camera-health-section" *ngIf="validatedRecordingCode">
          <div class="health-check-header">
            <h3>
              Verificação da Câmara
              <span *ngIf="isLoadingCameras" class="status-icon loading">
                <i class="fas fa-spinner fa-spin"></i>
              </span>
              <span *ngIf="isCheckingCamera && !isLoadingCameras" class="status-icon loading">
                <i class="fas fa-spinner fa-spin"></i>
              </span>
              <span *ngIf="cameraHealthCheckPassed && !isCheckingCamera && !isLoadingCameras" class="status-icon success">
                <i class="fas fa-check-circle"></i>
              </span>
              <span *ngIf="cameraHealthCheckFailed && !isCheckingCamera && !isLoadingCameras" class="status-icon error">
                <i class="fas fa-times-circle"></i>
              </span>
            </h3>
          </div>
          
          <!-- Loading Cameras State -->
          <div *ngIf="isLoadingCameras" class="health-status loading">
            <span>A carregar câmaras disponíveis...</span>
          </div>

      

          <!-- Success State -->
          <!--div *ngIf="cameraHealthCheckPassed && !isCheckingCamera && !isLoadingCameras" class="health-status success">
            <span>Câmara conectada com sucesso</span>
          </div-->

          <!-- Error State -->
          <!--div *ngIf="cameraHealthCheckFailed && !isCheckingCamera && !isLoadingCameras" class="health-status error">
            <span>{{ errorMessage }}</span>
            <button class="retry-button" (click)="retryCameraCheck()">
              Tentar Novamente
            </button>
          </div-->
        </div>
      </div>

      <div class="card-footer">
        <button class="button-red" (click)="onBackClick()">
          <span class="button-arrow">&lt;</span>
          <span>VOLTAR</span>
        </button>
        
        <!-- Continue without recording button (only shown when no code is validated) -->
        <button 
          *ngIf="!validatedRecordingCode"
          class="button-grey"
          (click)="continueWithoutRecording()"
          [disabled]="isValidatingCode">
          <span>NÃO GRAVAR</span>
        </button>
        
        <!-- Next button (only shown when code is validated) -->
        <button 
          *ngIf="validatedRecordingCode"
          class="button-green" 
          [class.disabled]="!canProceed()"
          [disabled]="!canProceed()"
          (click)="onNextClick()">
          <span>GRAVAR</span>
          <span class="button-arrow">></span>
        </button>
      </div>
    </div>
  </main>

  <!-- Tutorial Modal -->
  <app-tutorial-carousel-modal
    [isVisible]="isTutorialModalOpen"
    [title]="'Como funciona?'"
    [slides]="tutorialSlides"
    [closeText]="'Fechar'"
    (close)="closeTutorial()">
  </app-tutorial-carousel-modal>
</div> 