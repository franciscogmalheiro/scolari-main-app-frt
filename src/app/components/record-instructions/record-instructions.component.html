<div class="record-instructions-container">
  <app-header></app-header>

  <main class="main-content">
    <div class="instructions-card">
      <div class="card-header">
        <h1 class="card-title">Instruções do Marcador</h1>
      </div>

      <div class="instructions-content">
        <!-- Recording Code Section (only shown when no code is validated) -->
        <div class="recording-code-section" *ngIf="!validatedRecordingCode">
          <div class="section-header" *ngIf="!validatedRecordingCode">
            <h3>Gravação do Jogo</h3>
            <p class="description">
              Para gravar o jogo, falar com o responsável pelo campo para obter um código de gravação.
              Se não tiver código, pode continuar apenas com o marcador de jogo.
            </p>
          </div>
          
          <!-- Code validation form (only shown when no code is validated yet) -->
          <form [formGroup]="recordingCodeForm" (ngSubmit)="validateRecordingCode()" *ngIf="!validatedRecordingCode">
            <div class="code-input-group">
              <input 
                type="text" 
                formControlName="code" 
                placeholder="Código de gravação"
                class="code-input"
                [class.error]="codeValidationFailed">
              <button 
                type="submit" 
                class="validate-button"
                [disabled]="recordingCodeForm.invalid || isValidatingCode">
                <span *ngIf="!isValidatingCode">Validar Código</span>
                <span *ngIf="isValidatingCode" class="spinner"></span>
              </button>
            </div>
            
            <!-- Code validation error -->
            <div *ngIf="codeValidationFailed" class="validation-error">
              <span class="error-icon">❌</span>
              <span>{{ codeValidationError }}</span>
            </div>
          </form>
          
        </div>


        <!-- Instructions (only shown when recording code is validated) -->
        <div class="instruction-items" *ngIf="validatedRecordingCode">
          <h3>O teu código é válido, e o teu jogo irá ser gravado.</h3>
          <div class="instruction-item">
            <div class="instruction-number">1</div>
            <div class="instruction-text">
              A gravação do jogo terá inicio assim que o botão "iniciar" for premido.
            </div>
          </div>

          <div class="instruction-item">
            <div class="instruction-number">2</div>
            <div class="instruction-text">
              A gravação terá fim assim que o botão "terminar" for premido ou excedido o tempo limite de 90min.
            </div>
          </div>

          <div class="instruction-item">
            <div class="instruction-number">3</div>
            <div class="instruction-text">
              Assim que o botão "terminar" for pressionado, será apresentado o ID de jogo que vai precisar para descarregar o video.
            </div>
          </div>
        </div>

        <!-- Camera Health Check Section (only for recording mode) -->
        <div class="camera-health-section" *ngIf="validatedRecordingCode">
          <div class="health-check-header">
            <h3>Verificação da Câmara</h3>
          </div>
          
          <!-- Loading Cameras State -->
          <div *ngIf="isLoadingCameras" class="health-status loading">
            <div class="spinner"></div>
            <span>A carregar câmaras disponíveis...</span>
          </div>

          <!-- Loading State -->
          <div *ngIf="isCheckingCamera && !isLoadingCameras" class="health-status loading">
            <div class="spinner"></div>
            <span>A verificar ligação da câmara...</span>
          </div>

          <!-- Success State -->
          <div *ngIf="cameraHealthCheckPassed && !isCheckingCamera && !isLoadingCameras" class="health-status success">
            <span class="status-icon">✅</span>
            <span>Câmara conectada com sucesso</span>
            <div *ngIf="selectedCamera" class="camera-info">
              <small>{{ selectedCamera.cameraName }} ({{ selectedCamera.cameraModel }})</small>
            </div>
          </div>

          <!-- Error State -->
          <div *ngIf="cameraHealthCheckFailed && !isCheckingCamera && !isLoadingCameras" class="health-status error">
            <span class="status-icon">❌</span>
            <span>{{ errorMessage }}</span>
            <button class="retry-button" (click)="retryCameraCheck()">
              Tentar Novamente
            </button>
          </div>
        </div>
      </div>

      <div class="card-footer">
        <button class="back-button" (click)="onBackClick()">
          <span class="button-arrow">&lt;</span>
          <span>Voltar</span>
        </button>
        
        <!-- Continue without recording button (only shown when no code is validated) -->
        <button 
          *ngIf="!validatedRecordingCode"
          class="continue-button"
          (click)="continueWithoutRecording()"
          [disabled]="isValidatingCode">
          <span>Continuar sem gravação</span>
        </button>
        
        <!-- Next button (only shown when code is validated) -->
        <button 
          *ngIf="validatedRecordingCode"
          class="next-button" 
          [class.disabled]="!canProceed()"
          [disabled]="!canProceed()"
          (click)="onNextClick()">
          <span>Gravar jogo</span>
          <span class="button-arrow">></span>
        </button>
      </div>
    </div>
  </main>
</div> 